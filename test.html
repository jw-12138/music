<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Jacky.Q</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 ,minimum-scale=1, maximum-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <style>
        .wave{height: 100px;display: flex;justify-content: flex-start;align-items: center;overflow:hidden;position: relative;}
        .wave.one{align-items: flex-end;}
        .wave.two{align-items: flex-start;}
        .wave.three{height: 100px;}
        .wave .point{background-color: #666;border-radius: 5px;min-height: 1px;width: 2px;margin-right: 1px;}
        .wave.one .point{border-radius: 5px 5px 0 0;}
        .wave.two .point{border-radius: 0 0 5px 5px;}
        .wavePic{height: 100px;display: block;width: 100%;}
        .p{width:0;height: 100px;background: rgba(0,0,0,.1);position: absolute;top:0;left:0;}
    </style>
</head>

<body>
    <button class="play">play</button>
    <audio class="mp3" src="src/addictionToYou/audio.mp3"></audio>
    <img src="src/addictionToYou/wave.png" alt="" class="wavePic">
    <!-- <div class="wave one">
        
    </div>
    <div class="wave two">
        
    </div> -->
    <div class="wave three">
        <div class="p"></div>
    </div>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        let mp3 = $('.mp3')[0];
        let audioRate = 0;
        let channelOne = 0;
        let channelTwo = 0;
        let audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        mp3.ontimeupdate = function(){
            let n = mp3.currentTime;
            let d = mp3.duration;
            let p = n / d * 100;
            $('.p').css({'width':p + '%'});
        }

        function getData() {
            var request = new XMLHttpRequest();
            request.open('GET', 'src/addictionToYou/audio.mp3', true);
            request.responseType = 'arraybuffer';
            request.onloadstart = function(){
                console.log('loading...');
            }
            request.onload = function() {
                var audioData = request.response;
                audioCtx.decodeAudioData(audioData).then(function(decodedData) {
                    // use the decoded data here
                    audioRate = decodedData.sampleRate;
                    channelOne = decodedData.getChannelData(0);
                    channelTwo = decodedData.getChannelData(1);
                    let i = 1;

                    // set bar width in px
                    let barWidth = 3;

                    // let splitPoint = 1000;
                    let splitPoint = Math.floor($('body').width() / barWidth);
                    let _x = channelOne.length / splitPoint;
                    let data = {
                        c0:[],
                        c1:[]
                    };
                    let go = function(){
                        let r = parseInt(_x * i);
                        let sum0 = 0;
                        let avg0 = 0;
                        for (let j = 0; j < _x; j++) {
                            sum0 += Math.abs(parseFloat(channelOne[r - j]));
                        }
                        avg0 = sum0 / _x;
                        let sum1 = 0;
                        let avg1 = 0;
                        for (let j = 0; j < _x; j++) {
                            sum1 += Math.abs(parseFloat(channelTwo[r - j]));
                        }
                        avg1 = sum1 / _x;
                        let h1;
                        let h2;
                        let h3;
                        if (isNaN(avg0) || isNaN(avg1)) {
                            return false;
                        }
                        data.c0.push(avg0);
                        data.c1.push(avg1);
                        h1 = Math.abs(avg0) * 100;
                        h2 = Math.abs(avg1) * 100;
                        h3 = parseInt(h1 + h2);
                        $('.wave.three').append('<div class="point" style="height:'+h3+'%"></div>');
                        i++;
                        if(i >= splitPoint){
                            window.clearInterval(g);
                            console.log(data)
                            console.log('done');
                        }
                    }
                    let g = setInterval(go,1);
                    mp3.play();
                });
            }
            request.send();
        }
        
        $('.play').click(function(){
            $('.wave .point').remove();
            getData();
        });
    });
    </script>
</body>

</html>